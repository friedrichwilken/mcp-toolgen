package {{.Package}}

import (
	{{- if or .GenerateCRDResource .GenerateDocResource}}
	"context"

	{{- end}}
	"github.com/containers/kubernetes-mcp-server/pkg/api"
	internalk8s "github.com/containers/kubernetes-mcp-server/pkg/kubernetes"
	"github.com/containers/kubernetes-mcp-server/pkg/toolsets"
	{{- if or .GenerateCRDResource .GenerateDocResource}}
	ek8sapi "github.com/friedrichwilken/extendable-kubernetes-mcp-server/pkg/api"
	{{- end}}
)

// {{.CRD.Kind}}Toolset provides MCP tools for managing {{.CRD.Kind}} custom resources
type {{.CRD.Kind}}Toolset struct{}

// Ensure {{.CRD.Kind}}Toolset implements api.Toolset{{if or .GenerateCRDResource .GenerateDocResource}} and ek8sapi.ResourceProvider{{end}} interfaces
var _ api.Toolset = (*{{.CRD.Kind}}Toolset)(nil)
{{- if or .GenerateCRDResource .GenerateDocResource}}
var _ ek8sapi.ResourceProvider = (*{{.CRD.Kind}}Toolset)(nil)
{{- end}}

// GetName returns the name of this toolset
func (t *{{.CRD.Kind}}Toolset) GetName() string {
	return "{{.Toolset.GetToolsetName}}"
}

// GetDescription returns the description of this toolset
func (t *{{.CRD.Kind}}Toolset) GetDescription() string {
	return "{{.Toolset.GetToolsetDescription}}"
}

// GetTools returns all MCP tools provided by this toolset
func (t *{{.CRD.Kind}}Toolset) GetTools(o internalk8s.Openshift) []api.ServerTool {
	return []api.ServerTool{
		{{- range $operation := .Operations}}
		{{generateMethodName $operation $.CRD.Plural | ToLower}}Tool(),
		{{- end}}
	}
}

{{- if or .GenerateCRDResource .GenerateDocResource}}

// RegisterResources registers MCP resources for this toolset
func (t *{{.CRD.Kind}}Toolset) RegisterResources(registerFunc func(uri, name, mimeType string, handler func(context.Context) (string, error)) error) error {
	{{- if .GenerateCRDResource}}
	// Register CRD resource
	if err := registerFunc(
		"crd://{{.CRD.Group}}/{{.CRD.Version}}/{{.CRD.Kind}}",
		"{{.CRD.Kind}} {{.CRD.Version}} CRD",
		"text/yaml",
		func(_ context.Context) (string, error) {
			return embedded{{.CRD.Kind}}CRDYAML, nil
		},
	); err != nil {
		return err
	}
	{{- end}}
	{{- if .GenerateDocResource}}
	// Register documentation resource
	if err := registerFunc(
		"docs://{{.CRD.Group}}/{{.CRD.Version}}/{{.CRD.Kind}}",
		"{{.CRD.Kind}} Documentation",
		"text/markdown",
		func(_ context.Context) (string, error) {
			return embedded{{.CRD.Kind}}Documentation, nil
		},
	); err != nil {
		return err
	}
	{{- end}}
	return nil
}
{{- if .GenerateCRDResource}}

// embedded{{.CRD.Kind}}CRDYAML contains the complete CRD YAML definition
const embedded{{.CRD.Kind}}CRDYAML = `{{.CRD.YAMLContent}}`
{{- end}}
{{- if .GenerateDocResource}}

// embedded{{.CRD.Kind}}Documentation contains the embedded documentation
const embedded{{.CRD.Kind}}Documentation = `{{.CRD.DocContent}}`
{{- end}}
{{- end}}

{{range $operation := .Operations}}
// {{generateMethodName $operation $.CRD.Plural | ToLower}}Tool creates the MCP tool for {{$operation}} operations
func {{generateMethodName $operation $.CRD.Plural | ToLower}}Tool() api.ServerTool {
	return api.ServerTool{
		Tool: api.Tool{
			Name:        "{{generateToolName $operation $.CRD.Plural}}",
			Description: "{{$operation | ToTitle}} a {{$.CRD.Kind}} custom resource",
			InputSchema: {{$operation}}{{$.CRD.Kind}}Schema(),
		},
		Handler: Handle{{$operation | ToTitle}}{{$.CRD.Kind}},
	}
}

{{end}}

// init registers this toolset with the global registry
func init() {
	toolsets.Register(&{{.CRD.Kind}}Toolset{})
}
